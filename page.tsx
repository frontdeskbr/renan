<...long code omitted for brevity...>